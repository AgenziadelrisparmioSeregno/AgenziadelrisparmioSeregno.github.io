<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area Riservata | ADR Seregno</title>
    
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --adr-blue: #00b4ff; 
            --adr-dark: #050505;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        #safety-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9999; display: flex; align-items: center; justify-content: center;
        }

        .dashboard-bg {
            background: radial-gradient(circle at top right, #0a1120, #000000);
            min-height: 100vh; color: white; font-family: 'Inter', sans-serif; display: none; 
        }

        .dash-container { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-top: 30px; }
        @media (max-width: 992px) { .dash-container { grid-template-columns: 1fr; } }

        /* Status Pill Coerenti */
        .status-pill { padding: 5px 14px; border-radius: 6px; font-size: 0.6rem; font-weight: bold; text-transform: uppercase; font-family: 'Orbitron'; letter-spacing: 1px; }
        .status-active { background: rgba(0, 180, 255, 0.1); color: var(--adr-blue); border: 1px solid var(--adr-blue); }
        .status-pending { background: rgba(255, 255, 255, 0.05); color: #888; border: 1px solid #444; }
        
        .reveal { opacity: 0; transform: translateY(15px); transition: 0.8s all ease; }
        .reveal.active { opacity: 1; transform: translateY(0); }

        .pratica-card {
            background: var(--glass); padding: 20px; border-radius: 12px; margin-bottom: 15px;
            border: 1px solid var(--glass-border); border-left: 4px solid var(--adr-blue); transition: 0.3s;
        }
        .pratica-card:hover { background: rgba(255,255,255,0.07); border-color: var(--adr-blue); }

        #terminal-output {
            height: 180px; overflow-y: auto; background: rgba(0,0,0,0.4); 
            padding: 15px; font-family: 'Courier New', monospace; font-size: 0.75rem; 
            color: #ccc; border-radius: 8px; border: 1px solid var(--glass-border); 
            margin-bottom: 15px; scroll-behavior: smooth;
        }
        
        .scadenza-box {
            padding: 20px; background: rgba(0, 180, 255, 0.02); 
            border: 1px solid var(--glass-border); border-radius: 12px; text-align: center;
        }

        /* Input personalizzati per Dashboard */
        .dash-input {
            background: rgba(0,0,0,0.3); border: 1px solid #333; color: white; padding: 12px;
            border-radius: 6px; font-family: monospace;
        }
        .dash-input:focus { border-color: var(--adr-blue); outline: none; }

        /* Logo in Nav */
        .nav-logo { height: 35px; cursor: pointer; transition: 0.3s; }
        .nav-logo:hover { filter: drop-shadow(0 0 8px var(--adr-blue)); }

    </style>
</head>
<body class="dashboard-bg" id="main-body">

    <div id="safety-overlay">
        <div class="tech-font" style="color: var(--adr-blue); letter-spacing: 4px;">DECRIPTAZIONE INTERFACCIA...</div>
    </div>

    <nav style="display: flex; align-items: center; justify-content: space-between; padding: 15px 5%; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); position: sticky; top:0; z-index:1000; border-bottom: 1px solid var(--glass-border);">
        <div style="display: flex; align-items: center; gap: 20px;">
            <a href="index.html"><img src="logo.png" alt="ADR" class="nav-logo"></a>
            <span class="tech-font" style="color: #444; font-size: 0.6rem; letter-spacing: 2px;">SECURE_HUB v3.0</span>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <button class="btn" style="background: transparent; border: 1px solid #444; color: #888; font-size: 0.6rem; padding: 8px 15px; width: auto;" onclick="handleLogout()">LOGOUT</button>
        </div>
    </nav>

    <div class="container" style="margin-top: 50px; max-width: 1100px;">
        <div style="margin-bottom: 40px;" class="reveal">
            <h1 class="tech-font" style="font-size: 1.5rem; letter-spacing: 1px;">Benvenuto, <span id="user-name" style="color: var(--adr-blue);">...</span></h1>
            <p style="color: #555; font-size: 0.65rem; font-family: 'Orbitron';">ID_SESSIONE: <span id="user-id">...</span></p>
        </div>

        <div class="dash-container">
            <div>
                <div class="glass-card reveal" style="background: var(--glass); border: 1px solid var(--glass-border); padding: 30px;">
                    <h3 class="tech-font" style="font-size: 0.8rem; margin-bottom: 25px; color: var(--adr-blue);">Documentazione e Analisi</h3>
                    <div id="pratiche-list">
                        <p style="color: #444; font-size: 0.8rem;">Accesso al database ADR...</p>
                    </div>
                </div>

                <div class="glass-card reveal" style="margin-top: 30px; border-color: #222; background: rgba(0,0,0,0.2);">
                    <h4 class="tech-font" style="font-size: 0.65rem; color: #555; margin-bottom: 15px;">ADR_VIRTUAL_ASSISTANT</h4>
                    <div id="terminal-output">> SISTEMA ONLINE. Come posso aiutarti oggi?</div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="ai-input" class="dash-input" placeholder="Comando (es: aiuto, stato)..." style="flex-grow: 1;">
                        <button class="btn" onclick="runAICommand()" style="width: auto; padding: 0 25px; background: var(--adr-blue); color: black;">ESEGUI</button>
                    </div>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div class="glass-card reveal" style="border-top: 3px solid #ff4444;">
                    <h4 class="tech-font" style="font-size: 0.7rem; margin-bottom: 15px; color: #ff4444;">Monitoraggio Tariffe</h4>
                    <div class="scadenza-box">
                        <p style="font-size: 0.6rem; color: #666; margin: 0; text-transform: uppercase;">Ricalcolo Algoritmo tra:</p>
                        <div id="days-left" style="font-size: 2.2rem; font-weight: bold; color: white; margin: 5px 0;">---</div>
                        <p style="font-size: 0.5rem; color: var(--adr-blue); letter-spacing: 1px;">PROTEZIONE ADR ATTIVA</p>
                    </div>
                </div>

                <div class="glass-card reveal" style="text-align: center;">
                    <h4 class="tech-font" style="font-size: 0.7rem; margin-bottom: 15px; color: var(--adr-blue);">QR Invito Cliente</h4>
                    <div style="background: white; padding: 12px; display: inline-block; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 0 20px rgba(0,180,255,0.1);">
                        <img id="qrImage" src="" alt="QR" style="width: 130px; height: 130px; display: block;">
                    </div>
                    <p style="font-size: 0.6rem; color: #666; margin-bottom: 15px;">Condividi ADR per ottenere vantaggi esclusivi</p>
                    <button class="btn" id="copy-btn" onclick="copyRef()" style="width: 100%; font-size: 0.6rem; border: 1px solid var(--adr-blue); background: transparent; color: var(--adr-blue);">COPIA LINK PERSONALE</button>
                    <code id="refLink" style="display: none;"></code>
                </div>

                <div class="glass-card reveal" style="border-color: #222; text-align: center; background: linear-gradient(145deg, rgba(0,180,255,0.05), transparent);">
                    <div style="width: 40px; height: 40px; background: rgba(0, 180, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                        <span style="font-size: 1rem;">ðŸŽ§</span>
                    </div>
                    <h4 class="tech-font" style="font-size: 0.7rem;">Supporto Dedicato</h4>
                    <button class="btn" onclick="window.open('https://wa.me/393515910955')" style="width: 100%; background: white; color: black; font-weight: bold; margin-top: 10px;">WHATSAPP DIRECT</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhhfS7NKTC9ujs7GDUm04b6fVEKHvlPAU",
            authDomain: "adr-seregno.firebaseapp.com",
            projectId: "adr-seregno",
            storageBucket: "adr-seregno.firebasestorage.app",
            messagingSenderId: "893004573642",
            appId: "1:893004573642:web:f04e6f4ce48903547f7d33"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('main-body').style.display = 'block';
                document.getElementById('safety-overlay').style.display = 'none';
                document.getElementById('user-name').innerText = user.email.split('@')[0].toUpperCase();
                document.getElementById('user-id').innerText = user.uid.substring(0, 12) + "...";
                
                generateQR(user.uid);
                updateScadenza(user.uid);
                fetchUserPratiche(user.uid);

                setTimeout(() => {
                    document.querySelectorAll('.reveal').forEach((el, i) => {
                        setTimeout(() => el.classList.add('active'), i * 120);
                    });
                }, 400);
            } else {
                window.location.href = "login.html";
            }
        });

        // Generatore QR
        function generateQR(uid) {
            const fullRefLink = `${window.location.origin}/login.html?ref=${uid}`;
            document.getElementById('refLink').innerText = fullRefLink;
            document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(fullRefLink)}`;
        }

        // Terminale AI ADR
        window.runAICommand = async function() {
            const inputField = document.getElementById('ai-input');
            const input = inputField.value.toLowerCase().trim();
            const output = document.getElementById('terminal-output');
            if(!input) return;

            output.innerHTML += `<div style="color:var(--adr-blue); margin: 5px 0;">> ${input}</div>`;
            inputField.value = "";

            setTimeout(() => {
                let response = "Comando non riconosciuto. Digita 'aiuto'.";
                if (input === 'aiuto') response = "Comandi: 'stato' (verifica pratiche), 'scadenza' (check tariffe), 'consulente'.";
                else if (input === 'stato') response = "Analisi database: Pratiche sincronizzate correttamente.";
                else if (input === 'scadenza') response = "Il sistema sta monitorando le tue tariffe H24.";
                else if (input === 'consulente') response = "Canale WhatsApp in apertura...";

                output.innerHTML += `<div style="color:#888; margin-bottom:10px;">ADR_SYS: ${response}</div>`;
                output.scrollTop = output.scrollHeight;
            }, 600);
        }

        // Fetch Pratiche
        async function fetchUserPratiche(uid) {
            const listElement = document.getElementById('pratiche-list');
            try {
                const q = query(collection(db, "pratiche"), where("userId", "==", uid));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    listElement.innerHTML = `<div style="text-align:center; padding:30px; border:1px dashed #333; border-radius:10px; color:#666; font-size:0.8rem;">Nessun documento attivo.</div>`;
                    return;
                }
                
                listElement.innerHTML = ""; 
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const statusClass = data.stato === 'status-active' ? 'status-active' : 'status-pending';
                    listElement.innerHTML += `
                        <div class="pratica-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="font-family: 'Orbitron'; font-size: 0.8rem;">${data.nome}</strong>
                                <span class="status-pill ${statusClass}">${data.stato === 'status-active' ? 'Attivo' : 'In Corso'}</span>
                            </div>
                            <div style="margin-top: 15px; font-size: 0.65rem; color: #555; display: flex; justify-content: space-between;">
                                <span>Ref: ${data.consulente || 'Staff ADR'}</span>
                                <span>Data: ${data.data || '---'}</span>
                            </div>
                        </div>`;
                });
            } catch (error) { listElement.innerHTML = "Errore database."; }
        }

        async function updateScadenza(uid) {
            const q = query(collection(db, "pratiche"), where("userId", "==", uid));
            const snapshot = await getDocs(q);
            let scadenze = [];
            snapshot.forEach(doc => { if(doc.data().scadenza) scadenze.push(parseInt(doc.data().scadenza)); });
            document.getElementById('days-left').innerText = scadenze.length > 0 ? Math.min(...scadenze) + " GG" : "60 GG";
        }

        window.handleLogout = () => signOut(auth).then(() => window.location.href = "login.html");
        
        window.copyRef = function() {
            navigator.clipboard.writeText(document.getElementById('refLink').innerText);
            const btn = document.getElementById('copy-btn');
            btn.innerText = "COPIATO âœ…";
            setTimeout(() => btn.innerText = "COPIA LINK PERSONALE", 2000);
        }
    </script>
</body>
</html>
