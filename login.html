<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accesso Protetto | ADR Seregno</title>
    
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --adr-blue: #00b4ff; 
            --dark-bg: #050505; 
            --error-red: #ff4444; 
            --glass-white: rgba(255, 255, 255, 0.05);
        }

        body { 
            background: var(--dark-bg); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            display: flex; 
            flex-direction: column; /* Per allineare logo e box verticalmente */
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden; 
        }
        
        /* Background decorativo tecnologico ADR */
        body::before { 
            content: ""; position: absolute; width: 200%; height: 200%; 
            background: linear-gradient(rgba(0, 180, 255, 0.03) 1px, transparent 1px), 
                        linear-gradient(90deg, rgba(0, 180, 255, 0.03) 1px, transparent 1px); 
            background-size: 60px 60px; transform: rotate(10deg); z-index: -1; 
        }

        /* Stile Logo Home */
        .brand-container {
            margin-bottom: 20px;
            transition: 0.3s;
            z-index: 10;
        }
        .brand-container:hover {
            transform: translateY(-5px);
            filter: drop-shadow(0 0 10px var(--adr-blue));
        }
        .login-logo {
            height: 50px;
            width: auto;
            cursor: pointer;
        }

        .login-box { 
            background: var(--glass-white); 
            border: 1px solid #222; 
            padding: 45px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 400px; 
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5); 
            backdrop-filter: blur(15px); 
            position: relative; 
            border-top: 4px solid var(--adr-blue);
        }

        .tech-font { 
            font-family: 'Orbitron'; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            text-align: center; 
        }
        
        input { 
            width: 100%; 
            background: rgba(0,0,0,0.5); 
            border: 1px solid #333; 
            padding: 14px; 
            margin: 12px 0; 
            color: white; 
            border-radius: 8px; 
            outline: none; 
            box-sizing: border-box; 
            font-family: 'Inter'; 
            transition: 0.3s; 
        }
        
        input:focus { 
            border-color: var(--adr-blue); 
            box-shadow: 0 0 12px rgba(0, 180, 255, 0.3); 
            background: #000;
        }
        
        .btn-login { 
            width: 100%; 
            background: var(--adr-blue); 
            color: black; 
            border: none; 
            padding: 14px; 
            border-radius: 8px; 
            font-family: 'Orbitron'; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 25px; 
            transition: 0.3s; 
            text-transform: uppercase;
        }

        .btn-login:hover { 
            box-shadow: 0 0 20px var(--adr-blue); 
            transform: scale(1.02); 
            background: white;
        }

        .btn-login:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        .toggle-link { color: #888; font-size: 0.8rem; text-align: center; margin-top: 25px; cursor: pointer; transition: 0.3s; }
        .toggle-link:hover { color: white; }
        .toggle-link span { color: var(--adr-blue); font-weight: bold; }
        
        #message { font-size: 0.75rem; text-align: center; margin-top: 20px; min-height: 1.2em; font-family: 'Orbitron'; letter-spacing: 1px; }
        
        #ref-badge { 
            display: none; 
            background: rgba(0, 180, 255, 0.1); 
            border: 1px solid var(--adr-blue); 
            color: var(--adr-blue); 
            padding: 8px; 
            font-size: 0.65rem; 
            border-radius: 6px; 
            text-align: center; 
            margin-bottom: 20px; 
            font-family: 'Orbitron'; 
        }
    </style>
</head>
<body>

<div class="brand-container">
    <a href="index.html">
        <img src="logo.png" alt="ADR Home" class="login-logo">
    </a>
</div>

<div class="login-box">
    <div id="ref-badge">ACCESSO TRAMITE INVITO ATTIVO</div>
    <h2 class="tech-font" id="auth-title">LOGIN <span style="color:var(--adr-blue)">CLIENTE</span></h2>
    <p id="auth-desc" style="font-size: 0.65rem; color: #777; text-align: center; margin-bottom: 30px; font-family: 'Orbitron';">SISTEMA ADR-SHIELD v3.0</p>

    <input type="email" id="email" placeholder="Indirizzo Email">
    <input type="password" id="password" placeholder="Codice Password">
    
    <button class="btn-login" id="auth-btn">AUTENTICAZIONE TERMINALE</button>
    <div id="message"></div>

    <div class="toggle-link" id="toggle-auth">
        Nuovo utente? <span id="toggle-text">Inizializza Profilo</span>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAhhfS7NKTC9ujs7GDUm04b6fVEKHvlPAU",
        authDomain: "adr-seregno.firebaseapp.com",
        projectId: "adr-seregno",
        storageBucket: "adr-seregno.firebasestorage.app",
        messagingSenderId: "893004573642",
        appId: "1:893004573642:web:f04e6f4ce48903547f7d33",
        measurementId: "G-GM3L73YD68"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let isLoginMode = true;

    const urlParams = new URLSearchParams(window.location.search);
    const referrerId = urlParams.get('ref');
    if (referrerId) {
        localStorage.setItem('adr_referrer', referrerId);
        document.getElementById('ref-badge').style.display = 'block';
        switchMode(false); 
    }

    const authTitle = document.getElementById('auth-title');
    const authBtn = document.getElementById('auth-btn');
    const toggleLink = document.getElementById('toggle-auth');
    const toggleText = document.getElementById('toggle-text');
    const messageDiv = document.getElementById('message');

    function switchMode(login) {
        isLoginMode = login;
        authTitle.innerHTML = isLoginMode ? 'LOGIN <span style="color:var(--adr-blue)">CLIENTE</span>' : 'REGISTRA <span style="color:var(--adr-blue)">ACCOUNT</span>';
        authBtn.innerText = isLoginMode ? 'AUTENTICAZIONE TERMINALE' : 'CREA PROFILO ADR';
        toggleText.innerText = isLoginMode ? 'Inizializza Profilo' : 'Accedi al Terminale';
        messageDiv.innerText = "";
    }

    toggleLink.addEventListener('click', () => switchMode(!isLoginMode));

    authBtn.addEventListener('click', async () => {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        if(!email || !password) {
            showMessage("CAMPI INCOMPLETI", "var(--error-red)");
            return;
        }

        authBtn.disabled = true;
        showMessage("SCANSIONE CREDENZIALI...", "var(--adr-blue)");

        try {
            if (isLoginMode) {
                await signInWithEmailAndPassword(auth, email, password);
                window.location.href = "dashboard.html";
            } else {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await setDoc(doc(db, "users", user.uid), {
                    email: user.email,
                    role: "client",
                    createdAt: new Date().toISOString(),
                    invitedBy: localStorage.getItem('adr_referrer') || "direct",
                    points: 0
                });

                showMessage("PROFILO CREATO.", "var(--adr-blue)");
                setTimeout(() => { window.location.href = "dashboard.html"; }, 1500);
            }
        } catch (error) {
            authBtn.disabled = false;
            handleErrors(error);
        }
    });

    function showMessage(text, color) {
        messageDiv.style.color = color;
        messageDiv.innerText = text;
    }

    function handleErrors(error) {
        console.error(error.code);
        switch (error.code) {
            case 'auth/email-already-in-use':
                showMessage("EMAIL GIÃ€ PRESENTE.", "var(--error-red)");
                break;
            case 'auth/invalid-credential':
                showMessage("DATI ERRATI.", "var(--error-red)");
                break;
            case 'auth/weak-password':
                showMessage("PASSWORD DEBOLE.", "var(--error-red)");
                break;
            default:
                showMessage("ERRORE DI SISTEMA.", "var(--error-red)");
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (user) localStorage.setItem("userLogged", "true");
    });
</script>

</body>
</html>
